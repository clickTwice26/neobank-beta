{% extends "base.html" %}

{% block title %}Expenses - Expense Tracker{% endblock %}

{% block content %}
<div class="p-4 max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">All Expenses</h1>
        <p class="text-gray-600">View and manage your expense history</p>
    </div>

    <!-- Filters -->
    <div class="card mb-6" x-data="{ showFilters: false }">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-filter mr-2 text-blue-500"></i>
                Filters
            </h3>
            <button @click="showFilters = !showFilters" class="text-blue-600 hover:text-blue-500">
                <i class="fas fa-chevron-down" :class="showFilters ? 'rotate-180' : ''"></i>
            </button>
        </div>

        <form method="GET" x-show="showFilters" x-transition class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Category Filter -->
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="category" name="category" class="form-input">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" 
                                {% if category_filter|string == category.id|string %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Date From -->
                <div>
                    <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                    <input type="date" id="date_from" name="date_from" value="{{ date_from }}" class="form-input">
                </div>

                <!-- Date To -->
                <div>
                    <label for="date_to" class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                    <input type="date" id="date_to" name="date_to" value="{{ date_to }}" class="form-input">
                </div>
            </div>

            <div class="flex gap-3">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-search mr-2"></i>
                    Apply Filters
                </button>
                <a href="{{ url_for('expenses.list_expenses') }}" class="btn-secondary">
                    <i class="fas fa-undo mr-2"></i>
                    Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Expenses List -->
    {% if expenses %}
    <div class="space-y-4">
        {% for expense in expenses %}
        <div class="card hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4"
                         style="background-color: {{ expense.color }}20; color: {{ expense.color }}">
                        <span class="text-lg">{{ expense.icon }}</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">
                            {{ expense.description or expense.category_name }}
                        </h4>
                        <div class="flex items-center text-sm text-gray-500 mt-1">
                            <span class="mr-3">
                                <i class="fas fa-tag mr-1"></i>
                                {{ expense.category_name }}
                            </span>
                            <span class="mr-3">
                                <i class="fas fa-calendar mr-1"></i>
                                {{ expense.date }}
                            </span>
                            <span>
                                <i class="fas fa-clock mr-1"></i>
                                {{ expense.created_at.split(' ')[1].split('.')[0] }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="text-right flex items-center">
                    <div class="mr-4">
                        <p class="text-xl font-bold text-gray-900">${{ "%.2f"|format(expense.amount) }}</p>
                    </div>
                    <form method="POST" action="{{ url_for('expenses.delete_expense', expense_id=expense.id) }}" 
                          class="inline" onsubmit="return confirm('Are you sure you want to delete this expense?')">
                        <button type="submit" 
                                class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="mt-8 flex items-center justify-between">
        <div class="flex gap-2">
            {% if pagination.has_prev %}
            <a href="{{ url_for('expenses.list_expenses', page=pagination.prev_num, category=category_filter, date_from=date_from, date_to=date_to) }}" 
               class="btn-secondary">
                <i class="fas fa-chevron-left mr-2"></i>
                Previous
            </a>
            {% endif %}
            
            {% if pagination.has_next %}
            <a href="{{ url_for('expenses.list_expenses', page=pagination.next_num, category=category_filter, date_from=date_from, date_to=date_to) }}" 
               class="btn-secondary ml-auto">
                Next
                <i class="fas fa-chevron-right ml-2"></i>
            </a>
            {% endif %}
        </div>
        <div class="text-sm text-gray-500">
            Page {{ pagination.page }} of {{ pagination.pages }}
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="card text-center py-12">
        <div class="text-6xl mb-4">üìù</div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No expenses found</h3>
        <p class="text-gray-600 mb-6">
            {% if category_filter or date_from or date_to %}
                No expenses match your current filters. Try adjusting your search criteria.
            {% else %}
                You haven't recorded any expenses yet. Start by adding your first expense!
            {% endif %}
        </p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <a href="{{ url_for('expenses.add_expense') }}" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>
                Add First Expense
            </a>
            {% if category_filter or date_from or date_to %}
            <a href="{{ url_for('expenses.list_expenses') }}" class="btn-secondary">
                <i class="fas fa-undo mr-2"></i>
                Clear Filters
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
// Auto-expand filters if there are active filters
document.addEventListener('DOMContentLoaded', function() {
    const hasFilters = {{ 'true' if category_filter or date_from or date_to else 'false' }};
    if (hasFilters) {
        // Find the Alpine component and set showFilters to true
        setTimeout(() => {
            const filterCard = document.querySelector('[x-data*="showFilters"]');
            if (filterCard && filterCard._x_dataStack) {
                filterCard._x_dataStack[0].showFilters = true;
            }
        }, 100);
    }
});

// Bulk select functionality (for future enhancement)
function toggleAllExpenses() {
    const checkboxes = document.querySelectorAll('input[name="selected_expenses"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
}
</script>
{% endblock %}